<!DOCTYPE html>
<html lang="th" class="scroll-smooth">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚úçüèª‡∏û‡∏π‡πà‡∏Å‡∏±‡∏ô‡πÑ‡∏ü AI: Ultimate Writer's Studioüî•</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Font: Inter & Noto Sans Thai -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <!-- Markdown Parser (Marked.js) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    /* Global Styles */
    body {
      font-family: 'Inter', 'Noto Sans Thai', sans-serif;
      line-height: 1.7;
      background-color: #f8fafc;
      color: #1e293b;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Action Buttons */
    .action-btn {
        background-color: white; border: 1px solid #e2e8f0; color: #64748b;
        padding: 5px 8px; border-radius: 6px; cursor: pointer;
        font-size: 14px; display: flex; align-items: center; justify-content: center;
        transition: all 0.2s;
    }
    .action-btn:hover { background-color: #f1f5f9; color: #6366f1; transform: scale(1.05); }

    /* Result Box */
    .ai-result-box {
      background-color: #fff; border: 1px solid #e2e8f0; padding: 20px;
      border-radius: 12px; position: relative; margin-top: 12px;
    }

    /* Floating Action Buttons */
    .fab-container { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 10px; z-index: 50; }
    .fab-btn {
        width: 56px; height: 56px; border-radius: 50%;
        background: linear-gradient(135deg, #6366f1, #a855f7);
        color: white; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); border: none; cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .fab-btn:hover { transform: translateY(-2px) scale(1.05); }
    .speaking { animation: pulse-red 2s infinite; background: #ef4444 !important; }
    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(0,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); } }
    
    /* Chat */
    .chat-container { height: 400px; overflow-y: auto; padding: 16px; background: #f1f5f9; border-radius: 12px; }
    .chat-message { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 14px; margin-bottom: 8px; }
    .chat-user { align-self: flex-end; background: #6366f1; color: white; margin-left: auto; border-bottom-right-radius: 2px; }
    .chat-ai { align-self: flex-start; background: white; border: 1px solid #e2e8f0; color: #334155; margin-right: auto; border-bottom-left-radius: 2px; }

    .gradient-text { background-clip: text; -webkit-background-clip: text; color: transparent; background-image: linear-gradient(to right, #4f46e5, #9333ea, #db2777); }
    
    /* Custom Alert for API Key */
    .custom-alert {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background-color: rgba(0, 0, 0, 0.6); z-index: 1000;
        display: flex; justify-content: center; align-items: center;
    }
    .custom-alert-content {
        background: white; padding: 25px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        max-width: 400px; width: 90%; text-align: center;
    }
  </style>
</head>

<body class="bg-slate-50 text-slate-800">

  <!-- Header -->
  <header class="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm/50 backdrop-blur-md bg-white/90">
    <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center text-white">
          <i class="ph-bold ph-pen-nib"></i>
        </div>
        <span class="text-lg font-bold text-slate-800">‡∏û‡∏π‡πà‡∏Å‡∏±‡∏ô‡πÑ‡∏ü <span class="gradient-text">Ultimate</span></span>
      </div>
      <div class="text-xs text-slate-500 font-medium hidden sm:block">
        Gemini 2.5 + TTS üîä
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-6xl mx-auto p-4 md:p-6 space-y-8 pb-32">

    <!-- API Key Configuration Banner (Visible if key is not set) -->
    <div id="api-key-config" class="bg-red-50 border border-red-300 rounded-xl p-4 flex flex-col md:flex-row items-start md:items-center justify-between gap-4 transition-all duration-300">
        <div class="flex items-center gap-3">
            <i class="ph-bold ph-key text-red-600 text-2xl"></i>
            <div>
                <p class="font-bold text-red-800">‡πÇ‡∏õ‡∏£‡∏î‡πÉ‡∏™‡πà Gemini API Key ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
                <p class="text-red-700 text-sm">‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà ‡∏Ñ‡∏∏‡∏ì‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà API Key ‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</p>
            </div>
        </div>
        <div class="flex gap-2 w-full md:w-auto">
            <input type="password" id="key-input" class="p-2 border border-red-400 rounded-lg text-sm w-full md:w-64" placeholder="‡∏õ‡πâ‡∏≠‡∏ô API Key (AIza...)">
            <button id="save-key-btn" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition flex-shrink-0">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        </div>
    </div>
    
    <!-- Status message after saving key -->
    <div id="key-status-msg" class="hidden bg-green-50 border border-green-300 text-green-700 rounded-xl p-3 text-sm font-medium transition-all duration-300 flex items-center gap-2">
        <i class="ph-bold ph-check-circle text-lg"></i> API Key ‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß
    </div>

    <!-- 1. Visual Studio -->
    <section class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="flex border-b border-slate-100">
            <button id="tab-image" class="flex-1 py-3 px-4 font-semibold text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50/30 flex justify-center gap-2 items-center transition-all"><i class="ph ph-image"></i> ‡∏™‡∏ï‡∏π‡∏î‡∏¥‡πÇ‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û</button>
            <button id="tab-video" class="flex-1 py-3 px-4 font-medium text-slate-500 hover:bg-slate-50 flex justify-center gap-2 items-center transition-all"><i class="ph ph-film-strip"></i> ‡∏™‡∏ï‡∏π‡∏î‡∏¥‡πÇ‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</button>
        </div>
        <div class="p-6">
            <div id="content-image-gen">
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="w-full md:w-1/3 space-y-4">
                        <label class="text-sm font-semibold text-slate-700">‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏†‡∏≤‡∏û (Prompt)</label>
                        <textarea id="image-prompt" rows="4" class="w-full p-3 border border-slate-300 rounded-xl text-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå..."></textarea>
                        <button id="generate-image-btn" class="w-full bg-indigo-600 text-white font-semibold py-2.5 rounded-xl hover:bg-indigo-700 flex justify-center items-center gap-2 shadow-lg"><i class="ph-bold ph-magic-wand"></i> ‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û</button>
                    </div>
                    <div class="w-full md:w-2/3 bg-slate-100 rounded-xl border border-slate-200 min-h-[300px] flex items-center justify-center relative overflow-hidden" id="image-result-area">
                          <div class="text-center text-slate-400"><i class="ph ph-image text-4xl mb-2 opacity-50"></i><p class="text-sm">‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</p></div>
                    </div>
                </div>
            </div>
            <div id="content-video-gen" class="hidden text-center py-12"><p class="text-slate-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤...</p></div>
        </div>
    </section>

    <!-- 2. Creative Studio (Chat & Editor) -->
    <section class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative">
         <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-pink-500 to-rose-500"></div>
         <div class="flex border-b border-slate-100">
            <button id="tab-char" class="flex-1 py-3 px-4 font-semibold text-pink-600 border-b-2 border-pink-600 bg-pink-50/30 flex justify-center gap-2 items-center transition-all"><i class="ph ph-chats-circle"></i> ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</button>
            <button id="tab-editor" class="flex-1 py-3 px-4 font-medium text-slate-500 hover:bg-slate-50 flex justify-center gap-2 items-center transition-all"><i class="ph ph-article-medium"></i> ‡∏ö‡∏£‡∏£‡∏ì‡∏≤‡∏ò‡∏¥‡∏Å‡∏≤‡∏£ AI</button>
        </div>
        <div class="p-6">
            <!-- Chat -->
            <div id="content-char" class="block">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 space-y-4 p-4 bg-slate-50 rounded-xl border border-slate-200">
                        <input type="text" id="char-name" class="w-full p-2 border border-slate-300 rounded-lg text-sm" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£">
                        <textarea id="char-desc" rows="4" class="w-full p-2 border border-slate-300 rounded-lg text-sm" placeholder="‡∏ô‡∏¥‡∏™‡∏±‡∏¢ / ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó"></textarea>
                        <button id="char-start-btn" class="w-full bg-pink-600 text-white font-semibold py-2 rounded-lg hover:bg-pink-700 text-sm">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</button>
                    </div>
                    <div class="md:col-span-2 flex flex-col h-[400px]">
                         <div id="chat-history" class="chat-container flex-1 mb-4"></div>
                         <div class="flex gap-2">
                             <input type="text" id="chat-input" class="flex-1 p-3 border border-slate-300 rounded-xl text-sm" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." disabled>
                             <button id="chat-send-btn" class="bg-slate-800 text-white px-5 rounded-xl hover:bg-slate-900 disabled:opacity-50" disabled><i class="ph-bold ph-paper-plane-right"></i></button>
                         </div>
                    </div>
                </div>
            </div>
            <!-- Editor -->
            <div id="content-editor" class="hidden">
                <textarea id="editor-input" rows="6" class="w-full p-4 border border-slate-300 rounded-xl text-sm leading-relaxed" placeholder="‡∏ß‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢..."></textarea>
                <button id="editor-analyze-btn" class="bg-emerald-600 text-white font-semibold py-2.5 px-6 rounded-xl hover:bg-emerald-700 flex items-center gap-2 mx-auto mt-4"><i class="ph-bold ph-magnifying-glass"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
                <div id="editor-result" class="ai-result-box hidden">
                    <div id="editor-result-content" class="prose prose-sm max-w-none"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- 3. Text Tools -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-2 mb-4 text-sky-600 font-bold"><i class="ph-fill ph-lightbulb text-xl"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏•‡πá‡∏≠‡∏ï</div>
            <input id="plot-input" class="w-full p-2.5 border border-slate-200 rounded-lg text-sm mb-3" placeholder="‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î...">
            <button id="plot-btn" class="w-full bg-sky-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-sky-700">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢</button>
            <div id="plot-result" class="ai-result-box hidden p-4 text-sm"></div>
        </div>
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-2 mb-4 text-violet-600 font-bold"><i class="ph-fill ph-magic-wand text-xl"></i> ‡πÄ‡∏Å‡∏•‡∏≤‡∏™‡∏≥‡∏ô‡∏ß‡∏ô</div>
            <textarea id="refine-input" rows="1" class="w-full p-2.5 border border-slate-200 rounded-lg text-sm mb-3" placeholder="‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ..."></textarea>
            <button id="refine-btn" class="w-full bg-violet-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-violet-700">‡πÄ‡∏Å‡∏•‡∏≤‡∏†‡∏≤‡∏©‡∏≤</button>
            <div id="refine-result" class="ai-result-box hidden p-4 text-sm italic font-serif text-slate-700"></div>
        </div>
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-2 mb-4 text-rose-600 font-bold"><i class="ph-fill ph-megaphone text-xl"></i> ‡∏Ñ‡∏≥‡πÇ‡∏õ‡∏£‡∏¢</div>
            <textarea id="market-input" rows="1" class="w-full p-2.5 border border-slate-200 rounded-lg text-sm mb-3" placeholder="‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠..."></textarea>
            <button id="market-btn" class="w-full bg-rose-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-rose-700">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡πÇ‡∏õ‡∏£‡∏¢</button>
            <div id="market-result" class="ai-result-box hidden p-4 text-sm"></div>
        </div>
    </div>

    <!-- 4. NEW: TTS Audio Studio (Integrated & Themed) -->
    <section class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden mt-8">
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4 flex items-center justify-between">
             <h2 class="text-xl font-bold text-white flex items-center gap-2">
                <i class="ph-bold ph-microphone-stage"></i> ‡∏™‡∏ï‡∏π‡∏î‡∏¥‡πÇ‡∏≠‡∏•‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á (TTS Online)
             </h2>
             <span class="text-indigo-100 text-sm bg-white/20 px-3 py-1 rounded-full">‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î</span>
        </div>
        
        <div class="p-6 md:p-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Left: Controls -->
                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡∏á</label>
                        <textarea id="tts-text-input" rows="5" class="w-full p-4 border border-slate-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition resize-none text-sm" placeholder="‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ó‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Voice)</label>
                        <select id="tts-voice-select" class="w-full p-3 border border-slate-300 rounded-xl bg-white focus:ring-indigo-500 focus:border-indigo-500 cursor-pointer text-sm"></select>
                    </div>
                    <button id="tts-generate-btn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition transform active:scale-[0.98] flex justify-center items-center gap-2">
                        <i class="ph-bold ph-play-circle text-xl"></i> ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î
                    </button>
                </div>

                <!-- Right: Result & Status -->
                <div class="bg-slate-50 rounded-xl border border-slate-200 p-6 flex flex-col justify-center items-center min-h-[300px]">
                    
                    <!-- Initial State -->
                    <div id="tts-placeholder" class="text-center text-slate-400">
                        <i class="ph ph-wave-sound text-5xl mb-3 opacity-50"></i>
                        <p class="text-sm">‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                    </div>

                    <!-- Loading -->
                    <div id="tts-loading" class="hidden flex flex-col justify-center items-center space-y-3">
                        <i class="ph ph-spinner animate-spin text-indigo-600 text-3xl"></i>
                        <span class="text-indigo-600 font-medium text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á... ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</span>
                    </div>

                    <!-- Result -->
                    <div id="tts-result" class="hidden w-full space-y-6 text-center">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-indigo-100">
                             <i class="ph-fill ph-check-circle text-green-500 text-3xl mb-2"></i>
                             <h3 class="font-bold text-slate-800">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
                        </div>
                        
                        <audio id="tts-audio-player" controls class="w-full rounded-lg shadow-sm"></audio>
                        
                        <a id="tts-download-btn" href="#" download="tts_audio_gemini.wav" class="inline-flex items-center justify-center w-full bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 px-4 rounded-xl transition shadow-md gap-2">
                            <i class="ph-bold ph-download-simple"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á (.wav)
                        </a>
                    </div>

                    <!-- Error -->
                    <div id="tts-error" class="hidden w-full p-4 bg-red-50 text-red-700 border border-red-200 rounded-xl text-center text-sm">
                        <i class="ph-bold ph-warning-circle text-xl mb-1"></i>
                        <p id="tts-error-text">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

  </main>

  <!-- Global Floating Buttons -->
  <div class="fab-container">
      <div class="relative group">
          <button onclick="speakSelection()" class="fab-btn group-hover:scale-110"><i class="ph-bold ph-read-cv-logo text-2xl"></i></button>
          <div class="tooltip">‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
      </div>
      <div class="relative group">
          <button id="stop-speak-btn" onclick="stopSpeaking()" class="fab-btn bg-slate-700 hidden hover:bg-red-600"><i class="ph-bold ph-stop text-2xl"></i></button>
          <div class="tooltip">‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡πà‡∏≤‡∏ô</div>
      </div>
  </div>

  <!-- Logic -->
  <script type="module">
    // --- 1. Global Config & Helpers ---
    // API Key: Now managed via localStorage for portability
    let currentApiKey = ""; 
    const API_KEY_STORAGE_KEY = 'geminiWriterApiKey';
    const SYSTEM_PROMPT_WRITER = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏û‡∏π‡πà‡∏Å‡∏±‡∏ô‡πÑ‡∏ü" AI ‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û...`;
    
    // Check and load API Key on startup
    function loadApiKey() {
        const storedKey = localStorage.getItem(API_KEY_STORAGE_KEY);
        const configDiv = document.getElementById('api-key-config');
        const statusDiv = document.getElementById('key-status-msg');
        
        if (storedKey && storedKey.length > 10) {
            currentApiKey = storedKey;
            configDiv.classList.add('hidden');
            statusDiv.classList.remove('hidden');
            setTimeout(() => statusDiv.classList.add('hidden'), 5000); // Hide status after 5s
            console.log("API Key loaded from local storage.");
        } else {
            configDiv.classList.remove('hidden');
            statusDiv.classList.add('hidden');
            console.log("No API Key found. Please enter key.");
        }
    }

    // Save API Key
    document.getElementById('save-key-btn').addEventListener('click', () => {
        const input = document.getElementById('key-input');
        const key = input.value.trim();
        if (key.length > 10) { // Simple validation check
            localStorage.setItem(API_KEY_STORAGE_KEY, key);
            input.value = '';
            loadApiKey(); // Reload to update state and UI
            // You can add a success notification here if desired
        } else {
            // Replaced alert() with console log and UI notification text (for portability)
            document.getElementById('key-input').placeholder = "!! ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 10 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ !!";
            document.getElementById('key-input').classList.add('ring-2', 'ring-red-500');
            setTimeout(() => document.getElementById('key-input').classList.remove('ring-2', 'ring-red-500'), 2000);
        }
    });

    // Basic Fetch Helper for Text/Grounded Call
    async function callGemini(prompt, systemPrompt) {
        if (!currentApiKey) return "Error: ‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡πâ‡∏≠‡∏ô API Key ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
        try {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentApiKey}`;
            const res = await fetch(url, {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{parts: [{text: prompt}]}], systemInstruction: {parts: [{text: systemPrompt}]} })
            });
            if (!res.ok) {
                 const errorData = await res.json();
                 console.error("Gemini API Error (Text/TTS):", errorData);
                 throw new Error(`HTTP Error: ${res.status}. Check API Key or console for details.`);
            }
            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "Error: Failed to get response.";
        } catch (e) { return `Connection Error: ${e.message}`; }
    }
    
    // Image Generation using imagen-4.0-generate-001 (Recommended for standalone image gen)
    // *** FIXED: Switched model/endpoint and added exponential backoff ***
    async function callImageGenerator(promptText) {
        if (!currentApiKey) return null;
        const maxRetries = 5;
        let delay = 1000;
        const model = 'imagen-4.0-generate-001';
        // Use the :predict endpoint for Imagen 4.0
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${model}:predict?key=${currentApiKey}`;
        const payload = {
            instances: [{ prompt: promptText }],
            parameters: { 
                "sampleCount": 1,
            }
        };

        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.json();
                    console.error(`Image Generation API Error (Attempt ${i + 1}):`, errorBody);
                    
                    // Handle Quota Exceeded (429) errors with backoff
                    if (response.status === 429 && i < maxRetries - 1) {
                        // The server response might include a Retry-After header, but we use exponential backoff as a fallback
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Double the delay
                        continue;
                    }
                    
                    // For other errors, throw and stop retrying
                    throw new Error(`HTTP Error: ${response.status}. Check API Key or console for details.`);
                }

                const result = await response.json();
                // Imagen 4.0 returns image data in the 'predictions' array
                const base64Data = result?.predictions?.[0]?.bytesBase64Encoded;

                if (base64Data) return `data:image/png;base64,${base64Data}`;
                
                return null; 

            } catch (error) {
                // Handle network/parsing errors
                if (i < maxRetries - 1) {
                    console.warn(`Error during API call: ${error.message}. Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2;
                    continue;
                }
                console.error("Image generation failed after retries.");
                return null;
            }
        }
        return null;
    }

    // Helper for UI loading state
    function loading(el, text="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡∏¥‡∏î...") {
        el.classList.remove('hidden');
        el.innerHTML = `<div class="flex items-center gap-2 text-slate-500 justify-center py-4"><i class="ph ph-spinner animate-spin text-xl"></i> ${text}</div>`;
    }
    
    // --- 2. Existing Writer Features ---
    
    // Image Gen
    document.getElementById('generate-image-btn').addEventListener('click', async () => {
        const p = document.getElementById('image-prompt').value; 
        if(!p) return;
        if (!currentApiKey) { alertNotSet(); return; }
        
        const res = document.getElementById('image-result-area');
        res.innerHTML = '<i class="ph ph-spinner animate-spin text-3xl text-indigo-600"></i>';
        
        // Call the FIXED image generator
        const img = await callImageGenerator(p);
        res.innerHTML = img 
            ? `<img src="${img}" class="h-full w-full object-contain"><a href="${img}" download="art.png" class="absolute bottom-4 right-4 bg-white/90 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold shadow">Download</a>` 
            : '<div class="text-center text-slate-500 p-4"><i class="ph ph-warning-circle text-4xl mb-2 opacity-50"></i><p class="text-sm">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ (‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö API Key ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡∏´‡∏≤‡∏Å‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏¢‡∏±‡∏á‡∏Ñ‡∏á‡∏≠‡∏¢‡∏π‡πà ‡∏≠‡∏≤‡∏à‡∏´‡∏°‡∏≤‡∏¢‡∏ñ‡∏∂‡∏á‡πÇ‡∏Ñ‡∏ß‡∏ï‡πâ‡∏≤ API ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏´‡∏°‡∏î‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß)</p></div>';
    });
    
    // Helper for custom alert when key is missing (since alert() is forbidden)
    function alertNotSet() {
        const configDiv = document.getElementById('api-key-config');
        configDiv.classList.remove('hidden');
        configDiv.scrollIntoView({ behavior: 'smooth' });
        document.getElementById('key-input').focus();
    }

    // Character Chat
    let charName="", charDesc="";
    const chatHistory = document.getElementById('chat-history');
    
    // FIXED: Use DOM creation instead of innerHTML for safe button creation
    function addMessage(role, text) {
        const div = document.createElement('div');
        div.className = `chat-message ${role === 'user' ? 'chat-user' : 'chat-ai'}`;
        
        // Use markdown parser for AI text if needed, but for simple chat, plain text is okay.
        div.innerHTML = text.replace(/\n/g, '<br>'); // Simple line breaks

        if (role === 'ai') {
            const btn = document.createElement('button');
            btn.className = "ml-2 text-indigo-500 inline-flex items-center hover:scale-110 transition";
            btn.innerHTML = '<i class="ph-bold ph-speaker-high"></i>';
            btn.onclick = () => speakText(text);
            
            // Append button inside a span/div for better layout control if needed
            const wrapper = document.createElement('span');
            wrapper.className = "flex items-center";
            wrapper.innerHTML = text.replace(/\n/g, '<br>');
            wrapper.appendChild(btn);
            div.innerHTML = '';
            div.appendChild(wrapper);
        }
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    document.getElementById('char-start-btn').addEventListener('click', () => {
        charName = document.getElementById('char-name').value; charDesc = document.getElementById('char-desc').value;
        if(!charName) return;
        chatHistory.innerHTML = `<div class="text-center text-xs text-slate-400 my-4">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö ${charName}</div>`;
        document.getElementById('chat-input').disabled = false; document.getElementById('chat-send-btn').disabled = false;
    });
    
    async function sendChat() {
        const inp = document.getElementById('chat-input'); const txt = inp.value; 
        if(!txt) return;
        if (!currentApiKey) { alertNotSet(); return; }
        
        addMessage('user', txt);
        inp.value = "";
        
        const reply = await callGemini(`User: ${txt}`, `Roleplay as ${charName} (${charDesc}). Keep it short and in Thai.`);
        addMessage('ai', reply);
    }
    document.getElementById('chat-send-btn').addEventListener('click', sendChat);
    document.getElementById('chat-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendChat();
    });

    // Helper: Add Action Buttons Safely
    function addActions(containerId, textToSpeak) {
        const container = document.getElementById(containerId);
        // Remove existing action buttons first
        container.querySelectorAll('.action-buttons').forEach(el => el.remove());

        const btnDiv = document.createElement('div'); 
        btnDiv.className = "action-buttons flex gap-2 mb-4";
        
        const speakBtn = document.createElement('button'); 
        speakBtn.className="action-btn"; 
        speakBtn.innerHTML='<i class="ph ph-speaker-high"></i> ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á'; 
        speakBtn.onclick = () => speakText(textToSpeak);
        
        btnDiv.appendChild(speakBtn);
        container.prepend(btnDiv);
    }

    // Editor
    document.getElementById('editor-analyze-btn').addEventListener('click', async () => {
        const txt = document.getElementById('editor-input').value; 
        if(!txt) return;
        if (!currentApiKey) { alertNotSet(); return; }
        
        const res = document.getElementById('editor-result'); loading(res);
        const ans = await callGemini(txt, "Act as an editor. Critique this text in Thai using markdown (Strengths, Weaknesses, Tips).");
        res.innerHTML = `<div class="prose prose-sm max-w-none">${marked.parse(ans)}</div>`;
        addActions('editor-result', ans);
    });

    // Simple Tools
    const bindTool = (btn, inp, res, p) => {
        document.getElementById(btn).addEventListener('click', async () => {
            const v = document.getElementById(inp).value; 
            if(!v) return;
            if (!currentApiKey) { alertNotSet(); return; }
            
            const r = document.getElementById(res); loading(r);
            const a = await callGemini(`${p} ‡πÉ‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢: ${v}`, SYSTEM_PROMPT_WRITER);
            r.innerHTML = a.replace(/\n/g, '<br>');
            addActions(res, a);
        });
    };
    bindTool('plot-btn', 'plot-input', 'plot-result', 'Plot Idea');
    bindTool('refine-btn', 'refine-input', 'refine-result', 'Refine Sentence');
    bindTool('market-btn', 'market-input', 'market-result', 'Marketing Blurb');

    // --- 3. TTS Logic (Audio Processing) ---
    
    // Helper: Base64 to ArrayBuffer
    function base64ToArrayBuffer(base64) {
        const binaryString = window.atob(base64);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
        return bytes.buffer;
    }

    // Helper: Create WAV Blob from PCM16
    function pcmToWav(pcm16, sampleRate) {
        const numChannels = 1, bytesPerSample = 2, blockAlign = numChannels * bytesPerSample;
        const byteRate = sampleRate * blockAlign, dataSize = pcm16.length * bytesPerSample;
        const buffer = new ArrayBuffer(44 + dataSize), view = new DataView(buffer);
        let offset = 0;
        const writeString = (s) => { for (let i=0; i<s.length; i++) view.setUint8(offset+i, s.charCodeAt(i)); offset+=s.length; };

        writeString('RIFF'); view.setUint32(offset, 36+dataSize, true); offset+=4;
        writeString('WAVE'); writeString('fmt '); view.setUint32(offset, 16, true); offset+=4;
        view.setUint16(offset, 1, true); offset+=2; view.setUint16(offset, numChannels, true); offset+=2;
        view.setUint32(offset, sampleRate, true); offset+=4; view.setUint32(offset, byteRate, true); offset+=4;
        view.setUint16(offset, blockAlign, true); offset+=2; view.setUint16(offset, 16, true); offset+=2;
        writeString('data'); view.setUint32(offset, dataSize, true); offset+=4;
        for (let i=0; i<pcm16.length; i++, offset+=2) view.setInt16(offset, pcm16[i], true);
        return new Blob([buffer], { type: 'audio/wav' });
    }

    // Main TTS Function
    async function generateTTS() {
        const text = document.getElementById('tts-text-input').value.trim();
        const voice = document.getElementById('tts-voice-select').value;
        
        // UI Elements
        const ui = {
            btn: document.getElementById('tts-generate-btn'),
            place: document.getElementById('tts-placeholder'),
            load: document.getElementById('tts-loading'),
            res: document.getElementById('tts-result'),
            err: document.getElementById('tts-error'),
            player: document.getElementById('tts-audio-player'),
            dl: document.getElementById('tts-download-btn')
        };

        if(!text) { 
            document.getElementById('tts-error-text').innerText = "‡πÇ‡∏õ‡∏£‡∏î‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"; 
            ui.err.classList.remove('hidden'); 
            return; 
        }
        if (!currentApiKey) { alertNotSet(); return; }
        
        // Set Loading State
        ui.btn.disabled = true; ui.btn.classList.add('opacity-50');
        ui.place.classList.add('hidden'); ui.res.classList.add('hidden'); ui.err.classList.add('hidden');
        ui.load.classList.remove('hidden');

        try {
            // TTS uses gemini-2.5-flash-preview-tts
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${currentApiKey}`;

            // Call API
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: text }] }], 
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } } }
                    }
                })
            });

            if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
            const result = await response.json();
            
            const audioB64 = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
            const mimeType = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType || "audio/pcm;rate=24000";
            
            if (!audioB64) throw new Error("No Audio Data");

            // Process Audio
            const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)?.[1] || 24000);
            const wavBlob = pcmToWav(new Int16Array(base64ToArrayBuffer(audioB64)), sampleRate);
            const audioUrl = URL.createObjectURL(wavBlob);

            // Update UI Success
            ui.player.src = audioUrl; ui.player.load();
            ui.dl.href = audioUrl;
            ui.load.classList.add('hidden'); ui.res.classList.remove('hidden');
            
        } catch (error) {
            console.error(error);
            ui.load.classList.add('hidden');
            ui.err.classList.remove('hidden');
            document.getElementById('tts-error-text').innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message;
        } finally {
            ui.btn.disabled = false; ui.btn.classList.remove('opacity-50');
        }
    }

    // Initialize Voice Select
    const voices = [
        { name: "Pulcherrima", desc: "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏≤‡∏á)" },
        { name: "Leda", desc: "‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏¢‡∏≤‡∏ß‡πå (‡∏´‡∏ç‡∏¥‡∏á)" },
        { name: "Fenrir", desc: "‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏ï‡πâ‡∏ô (‡∏ä‡∏≤‡∏¢)" },
        { name: "Kore", desc: "‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏ô‡πà‡∏ô" },
        { name: "Puck", desc: "‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á" },
        { name: "Charon", desc: "‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£" }
    ];
    
    const vSelect = document.getElementById('tts-voice-select');
    voices.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.name; opt.text = `${v.name} - ${v.desc}`;
        if(v.name === "Pulcherrima") opt.selected = true;
        vSelect.appendChild(opt);
    });
    
    document.getElementById('tts-generate-btn').addEventListener('click', generateTTS);
    document.getElementById('tts-text-input').value = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏∏‡πâ‡∏á‡πÄ‡∏ï‡πâ‡∏ô ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≠‡∏á‡πÅ‡∏Æ‡∏õ‡∏õ‡∏µ‡πâ‡πÑ‡∏õ‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö?";

    // --- 4. Global Browser Speech (Backup) ---
    const browserSynth = window.speechSynthesis;
    window.speakText = (txt) => {
        browserSynth.cancel();
        const u = new SpeechSynthesisUtterance(txt); u.lang='th-TH';
        const btn = document.getElementById('stop-speak-btn');
        btn.classList.remove('hidden'); btn.classList.add('speaking');
        u.onend = () => { btn.classList.add('hidden'); btn.classList.remove('speaking'); };
        browserSynth.speak(u);
    };
    window.stopSpeaking = () => { browserSynth.cancel(); document.getElementById('stop-speak-btn').classList.add('hidden'); };
    window.speakContent = (id) => { const el = document.getElementById(id); if(el) window.speakText(el.innerText); };
    window.speakSelection = () => { const s = window.getSelection().toString(); if(s) window.speakText(s); };
    window.copyContent = (id) => { const el = document.getElementById(id); if(el) { navigator.clipboard.writeText(el.innerText); alert('Copied'); }};
    
    // Tab Setup
    const setupTabs = (btn1, btn2, c1, c2, col) => {
        const act = `border-${col}-600 text-${col}-600 bg-${col}-50/30`.split(' ');
        const inact = "text-slate-500 hover:bg-slate-50".split(' ');
        btn1.addEventListener('click', ()=>{c1.classList.remove('hidden');c2.classList.add('hidden');btn1.classList.add(...act);btn1.classList.remove(...inact);btn2.classList.remove(...act);btn2.classList.add(...inact);});
        btn2.addEventListener('click', ()=>{c2.classList.remove('hidden');c1.classList.add('hidden');btn2.classList.remove(...act);btn2.classList.add(...inact);btn1.classList.remove(...act);btn1.classList.add(...inact);});
    };
    setupTabs(document.getElementById('tab-image'), document.getElementById('tab-video'), document.getElementById('content-image-gen'), document.getElementById('content-video-gen'), 'indigo');
    setupTabs(document.getElementById('tab-char'), document.getElementById('tab-editor'), document.getElementById('content-char'), document.getElementById('content-editor'), 'pink');
    
    // Initial load
    window.onload = loadApiKey;

  </script>
</body>
</html>
