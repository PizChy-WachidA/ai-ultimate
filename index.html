<!DOCTYPE html>
<html lang="th" class="scroll-smooth">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‚úçüèª‡∏û‡∏π‡πà‡∏Å‡∏±‡∏ô‡πÑ‡∏ü AI: Ultimate Writer's Studioüî•</title>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Font: Inter & Noto Sans Thai -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <!-- Markdown Parser (Marked.js) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    /* Global Styles */
    body {
      font-family: 'Inter', 'Noto Sans Thai', sans-serif;
      line-height: 1.7;
      background-color: #f8fafc;
      color: #1e293b;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Action Buttons */
    .action-btn {
        background-color: white; border: 1px solid #e2e8f0; color: #64748b;
        padding: 5px 8px; border-radius: 6px; cursor: pointer;
        font-size: 14px; display: flex; align-items: center; justify-content: center;
        transition: all 0.2s;
    }
    .action-btn:hover { background-color: #f1f5f9; color: #6366f1; transform: scale(1.05); }

    /* Result Box */
    .ai-result-box {
      background-color: #fff; border: 1px solid #e2e8f0; padding: 20px;
      border-radius: 12px; position: relative; margin-top: 12px;
    }

    /* Floating Action Buttons */
    .fab-container { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 10px; z-index: 50; }
    .fab-btn {
        width: 56px; height: 56px; border-radius: 50%;
        background: linear-gradient(135deg, #6366f1, #a855f7);
        color: white; display: flex; align-items: center; justify-content: center;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); border: none; cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    .fab-btn:hover { transform: translateY(-2px) scale(1.05); }
    .speaking { animation: pulse-red 2s infinite; background: #ef4444 !important; }
    @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(0,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(0,0,0,0); } }
    
    /* Chat */
    .chat-container { height: 400px; overflow-y: auto; padding: 16px; background: #f1f5f9; border-radius: 12px; }
    .chat-message { max-width: 80%; padding: 10px 14px; border-radius: 12px; font-size: 14px; margin-bottom: 8px; }
    .chat-user { align-self: flex-end; background: #6366f1; color: white; margin-left: auto; border-bottom-right-radius: 2px; }
    .chat-ai { align-self: flex-start; background: white; border: 1px solid #e2e8f0; color: #334155; margin-right: auto; border-bottom-left-radius: 2px; }

    .gradient-text { background-clip: text; -webkit-background-clip: text; color: transparent; background-image: linear-gradient(to right, #4f46e5, #9333ea, #db2777); }
  </style>
</head>

<body class="bg-slate-50 text-slate-800">

  <!-- Header -->
  <header class="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm/50 backdrop-blur-md bg-white/90">
    <div class="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
      <div class="flex items-center gap-2">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-indigo-600 to-purple-600 flex items-center justify-center text-white">
          <i class="ph-bold ph-pen-nib"></i>
        </div>
        <span class="text-lg font-bold text-slate-800">‡∏û‡∏π‡πà‡∏Å‡∏±‡∏ô‡πÑ‡∏ü <span class="gradient-text">Ultimate</span></span>
      </div>
      <div class="text-xs text-slate-500 font-medium hidden sm:block">
        Gemini 2.5 + TTS üîä
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-6xl mx-auto p-4 md:p-6 space-y-8 pb-32">

    <!-- 1. Visual Studio -->
    <section class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="flex border-b border-slate-100">
            <button id="tab-image" class="flex-1 py-3 px-4 font-semibold text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50/30 flex justify-center gap-2 items-center transition-all"><i class="ph ph-image"></i> ‡∏™‡∏ï‡∏π‡∏î‡∏¥‡πÇ‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û</button>
            <button id="tab-video" class="flex-1 py-3 px-4 font-medium text-slate-500 hover:bg-slate-50 flex justify-center gap-2 items-center transition-all"><i class="ph ph-film-strip"></i> ‡∏™‡∏ï‡∏π‡∏î‡∏¥‡πÇ‡∏≠‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠</button>
        </div>
        <div class="p-6">
            <div id="content-image-gen">
                <div class="flex flex-col md:flex-row gap-6">
                    <div class="w-full md:w-1/3 space-y-4">
                        <label class="text-sm font-semibold text-slate-700">‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏†‡∏≤‡∏û (Prompt)</label>
                        <textarea id="image-prompt" rows="4" class="w-full p-3 border border-slate-300 rounded-xl text-sm focus:border-indigo-500 focus:ring-indigo-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô: ‡∏´‡πâ‡∏≠‡∏á‡∏™‡∏°‡∏∏‡∏î‡πÄ‡∏ß‡∏ó‡∏°‡∏ô‡∏ï‡∏£‡πå..."></textarea>
                        <button id="generate-image-btn" class="w-full bg-indigo-600 text-white font-semibold py-2.5 rounded-xl hover:bg-indigo-700 flex justify-center items-center gap-2 shadow-lg"><i class="ph-bold ph-magic-wand"></i> ‡∏ß‡∏≤‡∏î‡∏†‡∏≤‡∏û</button>
                    </div>
                    <div class="w-full md:w-2/3 bg-slate-100 rounded-xl border border-slate-200 min-h-[300px] flex items-center justify-center relative overflow-hidden" id="image-result-area">
                         <div class="text-center text-slate-400"><i class="ph ph-image text-4xl mb-2 opacity-50"></i><p class="text-sm">‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</p></div>
                    </div>
                </div>
            </div>
            <div id="content-video-gen" class="hidden text-center py-12"><p class="text-slate-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤...</p></div>
        </div>
    </section>

    <!-- 2. Creative Studio (Chat & Editor) -->
    <section class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative">
         <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-pink-500 to-rose-500"></div>
         <div class="flex border-b border-slate-100">
            <button id="tab-char" class="flex-1 py-3 px-4 font-semibold text-pink-600 border-b-2 border-pink-600 bg-pink-50/30 flex justify-center gap-2 items-center transition-all"><i class="ph ph-chats-circle"></i> ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£</button>
            <button id="tab-editor" class="flex-1 py-3 px-4 font-medium text-slate-500 hover:bg-slate-50 flex justify-center gap-2 items-center transition-all"><i class="ph ph-article-medium"></i> ‡∏ö‡∏£‡∏£‡∏ì‡∏≤‡∏ò‡∏¥‡∏Å‡∏≤‡∏£ AI</button>
        </div>
        <div class="p-6">
            <!-- Chat -->
            <div id="content-char" class="block">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="md:col-span-1 space-y-4 p-4 bg-slate-50 rounded-xl border border-slate-200">
                        <input type="text" id="char-name" class="w-full p-2 border border-slate-300 rounded-lg text-sm" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£">
                        <textarea id="char-desc" rows="4" class="w-full p-2 border border-slate-300 rounded-lg text-sm" placeholder="‡∏ô‡∏¥‡∏™‡∏±‡∏¢ / ‡∏ö‡∏ó‡∏ö‡∏≤‡∏ó"></textarea>
                        <button id="char-start-btn" class="w-full bg-pink-600 text-white font-semibold py-2 rounded-lg hover:bg-pink-700 text-sm">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤</button>
                    </div>
                    <div class="md:col-span-2 flex flex-col h-[400px]">
                         <div id="chat-history" class="chat-container flex-1 mb-4"></div>
                         <div class="flex gap-2">
                             <input type="text" id="chat-input" class="flex-1 p-3 border border-slate-300 rounded-xl text-sm" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." disabled>
                             <button id="chat-send-btn" class="bg-slate-800 text-white px-5 rounded-xl hover:bg-slate-900 disabled:opacity-50" disabled><i class="ph-bold ph-paper-plane-right"></i></button>
                         </div>
                    </div>
                </div>
            </div>
            <!-- Editor -->
            <div id="content-editor" class="hidden">
                <textarea id="editor-input" rows="6" class="w-full p-4 border border-slate-300 rounded-xl text-sm leading-relaxed" placeholder="‡∏ß‡∏≤‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢..."></textarea>
                <button id="editor-analyze-btn" class="w-full bg-emerald-600 text-white font-semibold py-2.5 px-6 rounded-xl hover:bg-emerald-700 flex justify-center items-center gap-2 mx-auto mt-4"><i class="ph-bold ph-magnifying-glass"></i> ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</button>
                <div id="editor-result" class="ai-result-box hidden">
                    <div id="editor-result-content" class="prose prose-sm max-w-none"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- 3. Text Tools -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-2 mb-4 text-sky-600 font-bold"><i class="ph-fill ph-lightbulb text-xl"></i> ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏û‡∏•‡πá‡∏≠‡∏ï</div>
            <input id="plot-input" class="w-full p-2.5 border border-slate-200 rounded-lg text-sm mb-3" placeholder="‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î...">
            <button id="plot-btn" class="w-full bg-sky-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-sky-700">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢</button>
            <div id="plot-result" class="ai-result-box hidden p-4 text-sm"></div>
        </div>
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-2 mb-4 text-violet-600 font-bold"><i class="ph-fill ph-magic-wand text-xl"></i> ‡πÄ‡∏Å‡∏•‡∏≤‡∏™‡∏≥‡∏ô‡∏ß‡∏ô</div>
            <textarea id="refine-input" rows="1" class="w-full p-2.5 border border-slate-200 rounded-lg text-sm mb-3" placeholder="‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ..."></textarea>
            <button id="refine-btn" class="w-full bg-violet-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-violet-700">‡πÄ‡∏Å‡∏•‡∏≤‡∏†‡∏≤‡∏©‡∏≤</button>
            <div id="refine-result" class="ai-result-box hidden p-4 text-sm italic font-serif text-slate-700"></div>
        </div>
        <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-2 mb-4 text-rose-600 font-bold"><i class="ph-fill ph-megaphone text-xl"></i> ‡∏Ñ‡∏≥‡πÇ‡∏õ‡∏£‡∏¢</div>
            <textarea id="market-input" rows="1" class="w-full p-2.5 border border-slate-200 rounded-lg text-sm mb-3" placeholder="‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡πà‡∏≠..."></textarea>
            <button id="market-btn" class="w-full bg-rose-600 text-white py-2 rounded-lg text-sm font-medium hover:bg-rose-700">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≥‡πÇ‡∏õ‡∏£‡∏¢</button>
            <div id="market-result" class="ai-result-box hidden p-4 text-sm"></div>
        </div>
    </div>

    <!-- 4. NEW: TTS Audio Studio (Integrated & Themed) -->
    <section class="bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden mt-8">
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 px-6 py-4 flex items-center justify-between">
             <h2 class="text-xl font-bold text-white flex items-center gap-2">
                <i class="ph-bold ph-microphone-stage"></i> ‡∏™‡∏ï‡∏π‡∏î‡∏¥‡πÇ‡∏≠‡∏•‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á (TTS Online)
             </h2>
             <span class="text-indigo-100 text-sm bg-white/20 px-3 py-1 rounded-full">‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î</span>
        </div>
        
        <div class="p-6 md:p-8">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Left: Controls -->
                <div class="space-y-5">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÅ‡∏õ‡∏•‡∏á</label>
                        <textarea id="tts-text-input" rows="5" class="w-full p-4 border border-slate-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition resize-none text-sm" placeholder="‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ó‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Voice)</label>
                        <select id="tts-voice-select" class="w-full p-3 border border-slate-300 rounded-xl bg-white focus:ring-indigo-500 focus:border-indigo-500 cursor-pointer text-sm"></select>
                    </div>
                    <button id="tts-generate-btn" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-3 px-6 rounded-xl shadow-lg transition transform active:scale-[0.98] flex justify-center items-center gap-2">
                        <i class="ph-bold ph-play-circle text-xl"></i> ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î
                    </button>
                </div>

                <!-- Right: Result & Status -->
                <div class="bg-slate-50 rounded-xl border border-slate-200 p-6 flex flex-col justify-center items-center min-h-[300px]">
                    
                    <!-- Initial State -->
                    <div id="tts-placeholder" class="text-center text-slate-400">
                        <i class="ph ph-wave-sound text-5xl mb-3 opacity-50"></i>
                        <p class="text-sm">‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏à‡∏∞‡∏õ‡∏£‡∏≤‡∏Å‡∏è‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</p>
                    </div>

                    <!-- Loading -->
                    <div id="tts-loading" class="hidden flex flex-col justify-center items-center space-y-3">
                        <i class="ph ph-spinner animate-spin text-indigo-600 text-3xl"></i>
                        <span class="text-indigo-600 font-medium text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á... ‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</span>
                    </div>

                    <!-- Result -->
                    <div id="tts-result" class="hidden w-full space-y-6 text-center">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-indigo-100">
                             <i class="ph-fill ph-check-circle text-green-500 text-3xl mb-2"></i>
                             <h3 class="font-bold text-slate-800">‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
                        </div>
                        
                        <audio id="tts-audio-player" controls class="w-full rounded-lg shadow-sm"></audio>
                        
                        <a id="tts-download-btn" href="#" download="tts_audio_gemini.wav" class="inline-flex items-center justify-center w-full bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 px-4 rounded-xl transition shadow-md gap-2">
                            <i class="ph-bold ph-download-simple"></i> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á (.wav)
                        </a>
                    </div>

                    <!-- Error -->
                    <div id="tts-error" class="hidden w-full p-4 bg-red-50 text-red-700 border border-red-200 rounded-xl text-center text-sm">
                        <i class="ph-bold ph-warning-circle text-xl mb-1"></i>
                        <p id="tts-error-text">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

  </main>

  <!-- Global Floating Buttons -->
  <div class="fab-container">
      <div class="relative group">
          <button onclick="speakSelection()" class="fab-btn group-hover:scale-110"><i class="ph-bold ph-read-cv-logo text-2xl"></i></button>
          <div class="tooltip">‡∏≠‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
      </div>
      <div class="relative group">
          <button id="stop-speak-btn" onclick="stopSpeaking()" class="fab-btn bg-slate-700 hidden hover:bg-red-600"><i class="ph-bold ph-stop text-2xl"></i></button>
          <div class="tooltip">‡∏´‡∏¢‡∏∏‡∏î‡∏≠‡πà‡∏≤‡∏ô</div>
      </div>
  </div>

  <!-- Logic -->
  <script type="module">
    // --- 1. Global Config & Helpers ---
    // *** REMOVED apiKey variable. All API calls now go through Vercel Proxy (api/gemini.js) ***
    const SYSTEM_PROMPT_WRITER = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ "‡∏û‡∏π‡πà‡∏Å‡∏±‡∏ô‡πÑ‡∏ü" AI ‡∏ô‡∏±‡∏Å‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û...`;
    
    // Helper: Call Vercel API Proxy
    async function callProxy(service, payload) {
        let retries = 0;
        const maxRetries = 3;
        while (retries < maxRetries) {
            try {
                const res = await fetch('/api/gemini', {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ service, payload })
                });

                // 4xx or 5xx error from proxy/API
                if (!res.ok) {
                    const errorJson = await res.json();
                    throw new Error(`Proxy Error: ${errorJson.error || res.statusText}`);
                }

                const data = await res.json();
                
                // If the proxy returns an error in the body
                if (data.error) {
                    throw new Error(`Gemini Error: ${data.error}`);
                }
                
                return data; // Return the full response data
            } catch (e) {
                console.error(`Attempt ${retries + 1} failed:`, e.message);
                if (retries < maxRetries - 1) {
                    const delay = Math.pow(2, retries) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                } else {
                    throw new Error(e.message); // Throw last error after all retries
                }
                retries++;
            }
        }
    }

    // Adaptor Functions to use the Proxy
    async function callGemini(prompt, systemPrompt) {
        try {
            const payload = { 
                model: 'gemini-2.5-flash-preview-09-2025',
                contents: [{parts: [{text: prompt}]}],
                systemInstruction: {parts: [{text: systemPrompt}]}
            };
            const result = await callProxy('gemini', payload);
            return result.candidates?.[0]?.content?.parts?.[0]?.text || "Error: Cannot extract text from API response.";
        } catch (e) {
            console.error(e);
            return `Error: ${e.message}`;
        }
    }
    
    async function callImagen(prompt) {
        try {
            const payload = { 
                model: 'imagen-4.0-generate-001',
                instances: [{ prompt: prompt }], 
                parameters: { sampleCount: 1 } 
            };
            const result = await callProxy('imagen', payload);
            if(result.predictions?.[0]?.bytesBase64Encoded) {
                return `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
            }
            return null;
        } catch (e) {
            console.error(e);
            return null;
        }
    }


    // --- 2. Existing Writer Features ---
    
    // Image Gen
    document.getElementById('generate-image-btn').addEventListener('click', async () => {
        const p = document.getElementById('image-prompt').value; if(!p) return;
        const res = document.getElementById('image-result-area');
        res.innerHTML = '<i class="ph ph-spinner animate-spin text-3xl text-indigo-600"></i>';
        const img = await callImagen(p);
        if (img) {
            res.innerHTML = `<img src="${img}" class="h-full w-full object-contain"><a href="${img}" download="art.png" class="absolute bottom-4 right-4 bg-white/90 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold shadow">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</a>`;
        } else {
            res.innerHTML = '<div class="text-center text-red-500"><i class="ph ph-warning-circle text-4xl mb-2"></i><p class="text-sm">‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏†‡∏≤‡∏û‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p></div>';
        }
    });

    // Character Chat
    let charName="", charDesc="";
    const chatHistory = document.getElementById('chat-history');
    
    // Helper to append messages safely using DOM (FIXED for SyntaxError)
    function addMessage(role, text) {
        const div = document.createElement('div');
        div.className = `chat-message ${role === 'user' ? 'chat-user' : 'chat-ai'}`;
        div.innerText = text;
        
        if (role === 'ai') {
            const btn = document.createElement('button');
            btn.className = "ml-2 text-indigo-500 inline-flex items-center hover:scale-110 transition";
            btn.innerHTML = '<i class="ph-bold ph-speaker-high"></i>';
            btn.onclick = () => speakText(text);
            div.appendChild(btn);
        }
        chatHistory.appendChild(div);
        chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    document.getElementById('char-start-btn').addEventListener('click', () => {
        charName = document.getElementById('char-name').value; charDesc = document.getElementById('char-desc').value;
        if(charName) chatHistory.innerHTML = `<div class="text-center text-xs text-slate-400 my-4">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö ${charName}</div>`;
        document.getElementById('chat-input').disabled = false; document.getElementById('chat-send-btn').disabled = false;
    });
    
    async function sendChat() {
        const inp = document.getElementById('chat-input'); const txt = inp.value; if(!txt) return;
        addMessage('user', txt);
        inp.value = "";
        
        const reply = await callGemini(`User: ${txt}`, `Roleplay as ${charName} (${charDesc}). Keep it short.`);
        addMessage('ai', reply);
    }
    document.getElementById('chat-send-btn').addEventListener('click', sendChat);

    // Editor
    document.getElementById('editor-analyze-btn').addEventListener('click', async () => {
        const txt = document.getElementById('editor-input').value; if(!txt) return;
        const res = document.getElementById('editor-result'); loading(res, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå...");
        
        const ans = await callGemini(txt, "Act as an editor. Critique this text in markdown (Strengths, Weaknesses, Tips).");
        
        res.classList.remove('hidden');
        document.getElementById('editor-result-content').innerHTML = marked.parse(ans);
        
        // Add speak/copy buttons using DOM
        const btnDiv = document.createElement('div'); btnDiv.className = "action-buttons flex gap-2 mb-4";
        const speakBtn = document.createElement('button'); speakBtn.className="action-btn"; speakBtn.innerHTML='<i class="ph ph-speaker-high"></i> ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á'; speakBtn.onclick = () => speakText(ans);
        btnDiv.appendChild(speakBtn);
        res.prepend(btnDiv);
    });

    // Simple Tools (FIXED for SyntaxError)
    const bindTool = (btn, inp, res, p) => {
        document.getElementById(btn).addEventListener('click', async () => {
            const v = document.getElementById(inp).value; if(!v) return;
            const r = document.getElementById(res); loading(r, "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...");
            
            const a = await callGemini(`${p}: ${v}`, SYSTEM_PROMPT_WRITER);
            
            r.classList.remove('hidden');
            r.innerHTML = a.replace(/\n/g, '<br>');
            
            // Add speak button using DOM
            const btnDiv = document.createElement('div'); btnDiv.className = "action-buttons flex gap-2 mb-4";
            const speakBtn = document.createElement('button'); speakBtn.className="action-btn"; speakBtn.innerHTML='<i class="ph ph-speaker-high"></i> ‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á'; speakBtn.onclick = () => speakText(a);
            btnDiv.appendChild(speakBtn);
            r.prepend(btnDiv);
        });
    };
    bindTool('plot-btn', 'plot-input', 'plot-result', 'Plot Idea');
    bindTool('refine-btn', 'refine-input', 'refine-result', 'Refine Sentence');
    bindTool('market-btn', 'market-input', 'market-result', 'Marketing Blurb');

    // --- 3. TTS Logic (Audio Processing) ---
    
    // Helper: Base64 to ArrayBuffer
    function base64ToArrayBuffer(base64) {
        const binaryString = window.atob(base64);
        const bytes = new Uint8Array(binaryString.length);
        for (let i = 0; i < binaryString.length; i++) bytes[i] = binaryString.charCodeAt(i);
        return bytes.buffer;
    }

    // Helper: Create WAV Blob from PCM16
    function pcmToWav(pcm16, sampleRate) {
        const numChannels = 1, bytesPerSample = 2, blockAlign = numChannels * bytesPerSample;
        const byteRate = sampleRate * blockAlign, dataSize = pcm16.length * bytesPerSample;
        const buffer = new ArrayBuffer(44 + dataSize), view = new DataView(buffer);
        let offset = 0;
        const writeString = (s) => { for (let i=0; i<s.length; i++) view.setUint8(offset+i, s.charCodeAt(i)); offset+=s.length; };

        writeString('RIFF'); view.setUint32(offset, 36+dataSize, true); offset+=4;
        writeString('WAVE'); writeString('fmt '); view.setUint32(offset, 16, true); offset+=4;
        view.setUint16(offset, 1, true); offset+=2; view.setUint16(offset, numChannels, true); offset+=2;
        view.setUint32(offset, sampleRate, true); offset+=4; view.setUint32(offset, byteRate, true); offset+=4;
        view.setUint16(offset, blockAlign, true); offset+=2; view.setUint16(offset, 16, true); offset+=2;
        writeString('data'); view.setUint32(offset, dataSize, true); offset+=4;
        for (let i=0; i<pcm16.length; i++, offset+=2) view.setInt16(offset, pcm16[i], true);
        return new Blob([buffer], { type: 'audio/wav' });
    }

    // Main TTS Function
    async function generateTTS() {
        const text = document.getElementById('tts-text-input').value.trim();
        const voice = document.getElementById('tts-voice-select').value;
        
        // UI Elements
        const ui = {
            btn: document.getElementById('tts-generate-btn'),
            place: document.getElementById('tts-placeholder'),
            load: document.getElementById('tts-loading'),
            res: document.getElementById('tts-result'),
            err: document.getElementById('tts-error'),
            player: document.getElementById('tts-audio-player'),
            dl: document.getElementById('tts-download-btn')
        };

        if(!text) { alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö"); return; }
        
        // Set Loading State
        ui.btn.disabled = true; ui.btn.classList.add('opacity-50');
        ui.place.classList.add('hidden'); ui.res.classList.add('hidden'); ui.err.classList.add('hidden');
        ui.load.classList.remove('hidden');

        try {
            // Construct Payload for Proxy
            const payload = {
                contents: [{ parts: [{ text: text }] }], 
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: voice } } }
                }
            };
            
            // Call Proxy
            const result = await callProxy('tts', payload);
            
            const audioB64 = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
            const mimeType = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.mimeType || "audio/pcm;rate=24000";
            
            if (!audioB64) throw new Error("No Audio Data received from API.");

            // Process Audio
            const sampleRate = parseInt(mimeType.match(/rate=(\d+)/)?.[1] || 24000);
            const wavBlob = pcmToWav(new Int16Array(base64ToArrayBuffer(audioB64)), sampleRate);
            const audioUrl = URL.createObjectURL(wavBlob);

            // Update UI Success
            ui.player.src = audioUrl; ui.player.load();
            ui.dl.href = audioUrl;
            ui.load.classList.add('hidden'); ui.res.classList.remove('hidden');
            
        } catch (error) {
            console.error(error);
            ui.load.classList.add('hidden');
            ui.err.classList.remove('hidden');
            document.getElementById('tts-error-text').innerText = "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message;
        } finally {
            ui.btn.disabled = false; ui.btn.classList.remove('opacity-50');
        }
    }

    // Initialize Voice Select
    const voices = [
        { name: "Pulcherrima", desc: "‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ (‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏•‡∏≤‡∏á)" },
        { name: "Leda", desc: "‡∏≠‡πà‡∏≠‡∏ô‡πÄ‡∏¢‡∏≤‡∏ß‡πå (‡∏´‡∏ç‡∏¥‡∏á)" },
        { name: "Fenrir", desc: "‡∏ï‡∏∑‡πà‡∏ô‡πÄ‡∏ï‡πâ‡∏ô (‡∏ä‡∏≤‡∏¢)" },
        { name: "Kore", desc: "‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏ô‡πà‡∏ô" },
        { name: "Puck", desc: "‡∏£‡πà‡∏≤‡πÄ‡∏£‡∏¥‡∏á" },
        { name: "Charon", desc: "‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£" }
    ];
    
    const vSelect = document.getElementById('tts-voice-select');
    voices.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.name; opt.text = `${v.name} - ${v.desc}`;
        if(v.name === "Pulcherrima") opt.selected = true;
        vSelect.appendChild(opt);
    });
    
    document.getElementById('tts-generate-btn').addEventListener('click', generateTTS);
    document.getElementById('tts-text-input').value = "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Å‡∏∏‡πâ‡∏á‡πÄ‡∏ï‡πâ‡∏ô ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏ô‡πâ‡∏≠‡∏á‡πÅ‡∏Æ‡∏õ‡∏õ‡∏µ‡πâ‡πÑ‡∏õ‡∏ß‡∏¥‡πà‡∏á‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö?";

    // --- 4. Global Browser Speech (Backup) ---
    const browserSynth = window.speechSynthesis;
    window.speakText = (txt) => {
        browserSynth.cancel();
        const u = new SpeechSynthesisUtterance(txt); u.lang='th-TH';
        const btn = document.getElementById('stop-speak-btn');
        btn.classList.remove('hidden'); btn.classList.add('speaking');
        u.onend = () => { btn.classList.add('hidden'); btn.classList.remove('speaking'); };
        browserSynth.speak(u);
    };
    window.stopSpeaking = () => { browserSynth.cancel(); document.getElementById('stop-speak-btn').classList.add('hidden'); };
    window.speakContent = (id) => { const el = document.getElementById(id); if(el) window.speakText(el.innerText); };
    window.speakSelection = () => { const s = window.getSelection().toString(); if(s) window.speakText(s); };
    window.copyContent = (id) => { const el = document.getElementById(id); if(el) { navigator.clipboard.writeText(el.innerText); alert('Copied'); }};
    
    // Tab Setup (Tabs logic reuse)
    const setupTabs = (btn1, btn2, c1, c2, col) => {
        const act = `border-${col}-600 text-${col}-600 bg-${col}-50/30`.split(' ');
        const inact = "text-slate-500 hover:bg-slate-50".split(' ');
        btn1.addEventListener('click', ()=>{c1.classList.remove('hidden');c2.classList.add('hidden');btn1.classList.add(...act);btn1.classList.remove(...inact);btn2.classList.remove(...act);btn2.classList.add(...inact);});
        btn2.addEventListener('click', ()=>{c2.classList.remove('hidden');c1.classList.add('hidden');btn2.classList.remove(...act);btn2.classList.add(...inact);btn1.classList.remove(...act);btn1.classList.add(...inact);});
    };
    setupTabs(document.getElementById('tab-image'), document.getElementById('tab-video'), document.getElementById('content-image-gen'), document.getElementById('content-video-gen'), 'indigo');
    setupTabs(document.getElementById('tab-char'), document.getElementById('tab-editor'), document.getElementById('content-char'), document.getElementById('content-editor'), 'pink');

  </script>
</body>
</html>
